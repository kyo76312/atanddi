<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>舊版公文讀取工具（AT / DI）</title>
<style>
.notice {
  font-size: 0.9em;   /* 字體感小 */
  color: #555;        /* 顏色灰色 */
  line-height: 1.6;
}

  body {
    font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
  }
  pre {
    background: #f5f5f5;
    padding: 12px;
    white-space: pre-wrap;
    border: 1px solid #ccc;
  }
</style>
</head>
<body>

<h2>舊版公文讀取工具</h2>

<div class="notice">
  目前僅支援簽&稿<br>
  不支援一個檔案中包含多個簽或稿<br>
  可能會有一些小問題(例如偶爾正本、副本可能讀取錯誤)<br>
  使用上有問題請打113告知
</div>


<h2>
  選擇 .at 或 .di 公文檔案<br>
  本網頁不會上傳任何文件，所有讀取與處理動作皆在您的裝置本機執行~
  若仍有疑慮，您可右鍵另存新檔將html檔案存在您的電腦上，亦可正常使用。
</h2>

<input type="file" id="fileInput" accept=".at,.di,.xml" />

<h2>擷取結果</h2>
<pre id="output">尚未載入檔案</pre>

<script>
document.getElementById("fileInput").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      parseDocument(e.target.result);
    } catch (err) {
      document.getElementById("output").textContent =
        "解析失敗，可能不是有效的公文檔案";
    }
  };
  reader.readAsText(file, "utf-8");
});

function parseDocument(text) {
  const parser = new DOMParser();

  // 保留原始 AT / DI 文件
  const atDoc = parser.parseFromString(text, "text/xml");

  // 內文文件（預設為自己）
  let contentDoc = atDoc;

  // 若為 AT，抽出 DI（但不覆蓋 atDoc）
  const diNode = atDoc.querySelector("Draft > DI");
  if (diNode && diNode.textContent.trim()) {
    const innerXML = diNode.textContent
      .replace(/&lt;/g, "<")
      .replace(/&gt;/g, ">")
      .replace(/&amp;/g, "&");
    contentDoc = parser.parseFromString(innerXML, "text/xml");
  }

  let result = "";

  // ===== 基本欄位（AT 或 DI 皆可）=====
  const typeNode = atDoc.querySelector("類別");
  if (typeNode) result += "類型：" + typeNode.textContent.trim() + "\n";

  const receiver = atDoc.querySelector("受文者 文字, 受文者");
  if (receiver) result += "受文者：" + receiver.textContent.trim() + "\n";

  const dateNode = atDoc.querySelector("發文日期 年月日");
  if (dateNode) result += "發文日期：" + dateNode.textContent.trim() + "\n";

  const noNode = atDoc.querySelector("發文字號");
  if (noNode) result += "發文字號：" + noNode.textContent.trim() + "\n";

  const attachNode = atDoc.querySelector("附件 文字");
  if (attachNode) result += "附件：" + attachNode.textContent.trim() + "\n";

  // ===== 內文（來自 DI）=====
  const subjectNode = contentDoc.querySelector("主旨 > 文字");
  if (subjectNode) {
    result += "\n主旨：\n" + subjectNode.textContent.trim() + "\n";
  }

  const explainNode = contentDoc.querySelector('段落[段名="說明："]');
  if (explainNode) {
    result += "\n說明：\n";
    const items = explainNode.querySelectorAll("條列 > 文字");
    if (items.length > 0) {
      items.forEach((item, i) => {
        result += (i + 1) + ". " + item.textContent.trim() + "\n";
      });
    } else {
      const textNode = explainNode.querySelector("文字");
      if (textNode) result += textNode.textContent.trim() + "\n";
    }
  }

  const planNode = contentDoc.querySelector('段落[段名="擬辦："] > 文字');
  if (planNode) {
    result += "\n擬辦：\n" + planNode.textContent.trim() + "\n";
  }

  // ===== 會辦單位（只從 AT / Template / 文稿屬性 抓）=====
  const coopNode = atDoc.querySelector("Template 文稿屬性 > 會辦單位");
  if (coopNode && coopNode.textContent.trim()) {
    result += "\n會辦單位：" + coopNode.textContent.trim() + "\n";
  }

  // ===== 正副本 =====
  const mainNodes = atDoc.querySelectorAll("正本 全銜");
  if (mainNodes.length > 0) {
    result += "\n正本：\n";
    mainNodes.forEach((node, i) => {
      result += (i + 1) + ". " + node.textContent.trim() + "\n";
    });
  }

  const copyNodes = atDoc.querySelectorAll("副本 全銜");
  if (copyNodes.length > 0) {
    result += "\n副本：\n";
    copyNodes.forEach((node, i) => {
      result += (i + 1) + ". " + node.textContent.trim() + "\n";
    });
  }

  // ===== 決行層級 =====
  const levelNode =
    atDoc.querySelector("決行層級值") ||
    atDoc.querySelector("AuthorizationLevel");
  if (levelNode) {
    result += "\n決行層級：" + levelNode.textContent.trim() + "\n";
  }

  document.getElementById("output").textContent =
    result.trim() || "未擷取到指定欄位";
}
</script>

</body>
</html>


